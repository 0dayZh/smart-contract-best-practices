
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Upgrading Broken Contracts Â· smart-contract-best-practices</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Consensus System LLC">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="pause_contract.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://github.com/ConsenSys/smart-contract-best-practices" target="_blank" class="custom-link">Contact us</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../general/">
            
                <a href="../general/">
            
                    
                    General Philosophy
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../general/philosophy.html">
            
                <a href="../general/philosophy.html">
            
                    
                    Developement philosophy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../general/tradeoffs.html">
            
                <a href="../general/tradeoffs.html">
            
                    
                    Fundamental Tradeoffs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../tips/">
            
                <a href="../tips/">
            
                    
                    Solidity Security Tips
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../tips/external_call.html">
            
                <a href="../tips/external_call.html">
            
                    
                    External Call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../tips/assert.html">
            
                <a href="../tips/assert.html">
            
                    
                    Assert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../tips/eth.html">
            
                <a href="../tips/eth.html">
            
                    
                    ETH/Balance Related
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../tips/contract_design.html">
            
                <a href="../tips/contract_design.html">
            
                    
                    Contract Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../tips/data_type.html">
            
                <a href="../tips/data_type.html">
            
                    
                    Data Type Related
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../tips/style.html">
            
                <a href="../tips/style.html">
            
                    
                    Style
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../tips/miscellaneous.html">
            
                <a href="../tips/miscellaneous.html">
            
                    
                    Miscellaneous
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../attacks/">
            
                <a href="../attacks/">
            
                    
                    Known Attacks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../attacks/race_condition.html">
            
                <a href="../attacks/race_condition.html">
            
                    
                    Race Condition
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="../attacks/race_condition.html">
            
                <a href="../attacks/race_condition.html#reentrancy">
            
                    
                    Reentrancy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="../attacks/race_condition.html">
            
                <a href="../attacks/race_condition.html#transaction-ordering-dependence">
            
                    
                    Transaction Ordering Dependence
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../attacks/gas_related_attacks.html">
            
                <a href="../attacks/gas_related_attacks.html">
            
                    
                    Gas Related Attacks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../attacks/overflow_underflow.html">
            
                <a href="../attacks/overflow_underflow.html">
            
                    
                    Overflow/Underflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../attacks/deprecated_attacks.html">
            
                <a href="../attacks/deprecated_attacks.html">
            
                    
                    Deprecated Attacks
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="./">
            
                <a href="./">
            
                    
                    Software Engineering Techniques
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.5.1" data-path="upgrade_contract.html">
            
                <a href="upgrade_contract.html">
            
                    
                    Upgrading Broken Contracts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="pause_contract.html">
            
                <a href="pause_contract.html">
            
                    
                    Circuit Breakers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="speed_bump.html">
            
                <a href="speed_bump.html">
            
                    
                    Speed Bumps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="limit_rate.html">
            
                <a href="limit_rate.html">
            
                    
                    Rate Limiting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="contract_rollout.html">
            
                <a href="contract_rollout.html">
            
                    
                    Contract Rollout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="bounties.html">
            
                <a href="bounties.html">
            
                    
                    Bug Bounty Program
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../specification/">
            
                <a href="../specification/">
            
                    
                    Security Related Documentation and Procedure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../tools/">
            
                <a href="../tools/">
            
                    
                    Security Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../resource/">
            
                <a href="../resource/">
            
                    
                    Security Notification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../bibliography/">
            
                <a href="../bibliography/">
            
                    
                    Bibliography
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Upgrading Broken Contracts</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h3 id="upgrading-broken-contracts">Upgrading Broken Contracts</h3>
<p>Code will need to be changed if errors are discovered or if improvements need to be made. It is no good to discover a bug, but have no way to deal with it.</p>
<p>Designing an effective upgrade system for smart contracts is an area of active research, and we won&apos;t be able to cover all of the complications in this document. However, there are two basic approaches that are most commonly used. The simpler of the two is to have a registry contract that holds the address of the latest version of the contract. A more seamless approach for contract users is to have a contract that forwards calls and data onto the latest version of the contract.</p>
<p>Whatever the technique, it&apos;s important to have modularization and good separation between components, so that code changes do not break functionality, orphan data, or require substantial costs to port. In particular, it is usually beneficial to separate complex logic from your data storage, so that you do not have to recreate all of the data in order to change the functionality.</p>
<p>It&apos;s also critical to have a secure way for parties to decide to upgrade the code. Depending on your contract, code changes may need to be approved by a single trusted party, a group of members, or a vote of the full set of stakeholders. If this process can take some time, you will want to consider if there are other ways to react more quickly in case of an attack, such as an <a href="techniques/pause_contract.md">emergency stop or circuit-breaker</a>.</p>
<p><strong>Example 1: Use a registry contract to store latest version of a contract</strong></p>
<p>In this example, the calls aren&apos;t forwarded, so users should fetch the current address each time before interacting with it.</p>
<pre><code>contract SomeRegister {
    address backendContract;
    address[] previousBackends;
    address owner;

    function SomeRegister() {
        owner = msg.sender;
    }

    modifier onlyOwner() {
        if (msg.sender != owner) {
            throw;
        }
        _;
    }

    function changeBackend(address newBackend) public
    onlyOwner()
    returns (bool)
    {
        if(newBackend != backendContract) {
            previousBackends.push(backendContract);
            backendContract = newBackend;
            return true;
        }

        return false;
    }
}
</code></pre><p>There are two main disadvantages to this approach:</p>
<ol>
<li>Users must always look up the current address, and anyone who fails to do so risks using an old version of the contract</li>
<li>You will need to think carefully about how to deal with the contract data, when you replace the contract</li>
</ol>
<p>The alternate approach is to have a contract forward calls and data to the latest version of the contract:</p>
<p><strong>Example 2: <a href="http://ethereum.stackexchange.com/questions/2404/upgradeable-contracts" target="_blank">Use a <code>DELEGATECALL</code></a> to forward data and calls</strong></p>
<pre><code>contract Relay {
    address public currentVersion;
    address public owner;

    modifier onlyOwner() {
        if (msg.sender != owner) {
            throw;
        }
        _;
    }

    function Relay(address initAddr) {
        currentVersion = initAddr;
        owner = msg.sender; // this owner may be another contract with multisig, not a single contract owner
    }

    function changeContract(address newVersion) public
    onlyOwner()
    {
        currentVersion = newVersion;
    }

    function() {
        if(!currentVersion.delegatecall(msg.data)) throw;
    }
}
</code></pre><p>This approach avoids the previous problems, but has problems of its own. You must be extremely careful with how you store data in this contract. If your new contract has a different storage layout than the first, your data may end up corrupted. Additionally, this simple version of the pattern cannot return values from functions, only forward them, which limits its applicability. (<a href="https://github.com/ownage-ltd/ether-router" target="_blank">More complex implementations</a> attempt to solve this with in-line assembly code and a registry of return sizes.)</p>
<p>Regardless of your approach, it is important to have some way to upgrade your contracts, or they will become unusable when the inevitable bugs are discovered in them.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Software Engineering Techniques">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="pause_contract.html" class="navigation navigation-next " aria-label="Next page: Circuit Breakers">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Upgrading Broken Contracts","level":"1.5.1","depth":2,"next":{"title":"Circuit Breakers","level":"1.5.2","depth":2,"path":"techniques/pause_contract.md","ref":"techniques/pause_contract.md","articles":[]},"previous":{"title":"Software Engineering Techniques","level":"1.5","depth":1,"path":"techniques/README.md","ref":"techniques/README.md","articles":[{"title":"Upgrading Broken Contracts","level":"1.5.1","depth":2,"path":"techniques/upgrade_contract.md","ref":"techniques/upgrade_contract.md","articles":[]},{"title":"Circuit Breakers","level":"1.5.2","depth":2,"path":"techniques/pause_contract.md","ref":"techniques/pause_contract.md","articles":[]},{"title":"Speed Bumps","level":"1.5.3","depth":2,"path":"techniques/speed_bump.md","ref":"techniques/speed_bump.md","articles":[]},{"title":"Rate Limiting","level":"1.5.4","depth":2,"path":"techniques/limit_rate.md","ref":"techniques/limit_rate.md","articles":[]},{"title":"Contract Rollout","level":"1.5.5","depth":2,"path":"techniques/contract_rollout.md","ref":"techniques/contract_rollout.md","articles":[]},{"title":"Bug Bounty Program","level":"1.5.6","depth":2,"path":"techniques/bounties.md","ref":"techniques/bounties.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":[],"root":"./docs","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Consensus System LLC","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"smart-contract-best-practices","language":"en","links":{"sidebar":{"Contact us":"https://github.com/ConsenSys/smart-contract-best-practices"}},"gitbook":">=3.0.0","description":""},"file":{"path":"techniques/upgrade_contract.md","mtime":"2017-09-21T02:03:23.675Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-09-21T02:24:05.143Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

