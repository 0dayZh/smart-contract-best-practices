
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Gas Related Attacks Â· smart-contract-best-practices</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Consensus System LLC">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="overflow_underflow.html" />
    
    
    <link rel="prev" href="race_condition.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://github.com/ConsenSys/smart-contract-best-practices" target="_blank" class="custom-link">Contact us</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../general/">
            
                <a href="../general/">
            
                    
                    General Philosophy
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../general/philosophy.html">
            
                <a href="../general/philosophy.html">
            
                    
                    Developement philosophy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../general/tradeoffs.html">
            
                <a href="../general/tradeoffs.html">
            
                    
                    Fundamental Tradeoffs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../tips/">
            
                <a href="../tips/">
            
                    
                    Solidity Security Tips
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../tips/external_call.html">
            
                <a href="../tips/external_call.html">
            
                    
                    External Call
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../tips/assert.html">
            
                <a href="../tips/assert.html">
            
                    
                    Assert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../tips/eth.html">
            
                <a href="../tips/eth.html">
            
                    
                    ETH/Balance Related
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../tips/contract_design.html">
            
                <a href="../tips/contract_design.html">
            
                    
                    Contract Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../tips/data_type.html">
            
                <a href="../tips/data_type.html">
            
                    
                    Data Type Related
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../tips/style.html">
            
                <a href="../tips/style.html">
            
                    
                    Style
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../tips/miscellaneous.html">
            
                <a href="../tips/miscellaneous.html">
            
                    
                    Miscellaneous
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Known Attacks
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="race_condition.html">
            
                <a href="race_condition.html">
            
                    
                    Race Condition
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="race_condition.html">
            
                <a href="race_condition.html#reentrancy">
            
                    
                    Reentrancy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="race_condition.html">
            
                <a href="race_condition.html#transaction-ordering-dependence">
            
                    
                    Transaction Ordering Dependence
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.4.2" data-path="gas_related_attacks.html">
            
                <a href="gas_related_attacks.html">
            
                    
                    Gas Related Attacks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="overflow_underflow.html">
            
                <a href="overflow_underflow.html">
            
                    
                    Overflow/Underflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="deprecated_attacks.html">
            
                <a href="deprecated_attacks.html">
            
                    
                    Deprecated Attacks
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../techniques/">
            
                <a href="../techniques/">
            
                    
                    Software Engineering Techniques
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../techniques/upgrade_contract.html">
            
                <a href="../techniques/upgrade_contract.html">
            
                    
                    Upgrading Broken Contracts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../techniques/pause_contract.html">
            
                <a href="../techniques/pause_contract.html">
            
                    
                    Circuit Breakers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../techniques/speed_bump.html">
            
                <a href="../techniques/speed_bump.html">
            
                    
                    Speed Bumps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../techniques/limit_rate.html">
            
                <a href="../techniques/limit_rate.html">
            
                    
                    Rate Limiting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../techniques/contract_rollout.html">
            
                <a href="../techniques/contract_rollout.html">
            
                    
                    Contract Rollout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../techniques/bounties.html">
            
                <a href="../techniques/bounties.html">
            
                    
                    Bug Bounty Program
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../specification/">
            
                <a href="../specification/">
            
                    
                    Security Related Documentation and Procedure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../tools/">
            
                <a href="../tools/">
            
                    
                    Security Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../resource/">
            
                <a href="../resource/">
            
                    
                    Security Notification
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../bibliography/">
            
                <a href="../bibliography/">
            
                    
                    Bibliography
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Gas Related Attacks</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p><a name="dos-with-unexpected-throw"></a></p>
<h3 id="dos-with-unexpected-throw">DoS with (Unexpected) Throw</h3>
<p>Consider a simple auction contract:</p>
<pre><code>// INSECURE
contract Auction {
    address currentLeader;
    uint highestBid;

    function bid() payable {
        if (msg.value &lt;= highestBid) { throw; }

        if (!currentLeader.send(highestBid)) { throw; } // Refund the old leader, and throw if it fails

        currentLeader = msg.sender;
        highestBid = msg.value;
    }
}
</code></pre><p>When it tries to refund the old leader, it throws if the refund fails. This means that a malicious bidder can become the leader, while making sure that any refunds to their address will <em>always</em> fail. In this way, they can prevent anyone else from calling the <code>bid()</code> function, and stay the leader forever. A recommendation is to set up a <a href="tips/external_call.md#favor-pull-over-push-payments">pull payment system</a> instead, as described earlier.</p>
<p>Another example is when a contract may iterate through an array to pay users (e.g., supporters in a crowdfunding contract). It&apos;s common to want to make sure that each payment succeeds. If not, one should throw. The issue is that if one call fails, you are reverting the whole payout system, meaning the loop will never complete. No one gets paid, because one address is forcing an error.</p>
<pre><code>address[] private refundAddresses;
mapping (address =&gt; uint) public refunds;

// bad
function refundAll() public {
    for(uint x; x &lt; refundAddresses.length; x++) { // arbitrary length iteration based on how many addresses participated
        if(refundAddresses[x].send(refunds[refundAddresses[x]])) {
            throw; // doubly bad, now a single failure on send will hold up all funds
        }
    }
}
</code></pre><p>Again, the recommended solution is to <a href="tips/external_call.md#favor-pull-over-push-payments">favor pull over push payments</a>.</p>
<p><a name="dos-with-block-gas-limit"></a></p>
<h3 id="dos-with-block-gas-limit">DoS with Block Gas Limit</h3>
<p>You may have noticed another problem with the previous example: by paying out to everyone at once, you risk running into the block gas limit. Each Ethereum block can process a certain maximum amount of computation. If you try to go over that, your transaction will fail.</p>
<p>This can lead to problems even in the absence of an intentional attack. However, it&apos;s especially bad if an attacker can manipulate the amount of gas needed. In the case of the previous example, the attacker could add a bunch of addresses, each of which needs to get a very small refund. The gas cost of refunding each of the attacker&apos;s addresses could therefore end up being more than the gas limit, blocking the refund transaction from happening at all.</p>
<p>This is another reason to <a href="tips/external_call.md#favor-pull-over-push-payments">favor pull over push payments</a>.</p>
<p>If you absolutely must loop over an array of unknown size, then you should plan for it to potentially take multiple blocks, and therefore require multiple transactions. You will need to keep track of how far you&apos;ve gone, and be able to resume from that point, as in the following example:</p>
<pre><code>struct Payee {
    address addr;
    uint256 value;
}
Payee payees[];
uint256 nextPayeeIndex;

function payOut() {
    uint256 i = nextPayeeIndex;
    while (i &lt; payees.length &amp;&amp; msg.gas &gt; 200000) {
      payees[i].addr.send(payees[i].value);
      i++;
    }
    nextPayeeIndex = i;
}
</code></pre><p>You will need to make sure that nothing bad will happen if other transactions are processed while waiting for the next iteration of the <code>payOut()</code> function. So only use this pattern if absolutely necessary.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="race_condition.html#transaction-ordering-dependence" class="navigation navigation-prev " aria-label="Previous page: Transaction Ordering Dependence">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="overflow_underflow.html" class="navigation navigation-next " aria-label="Next page: Overflow/Underflow">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Gas Related Attacks","level":"1.4.2","depth":2,"next":{"title":"Overflow/Underflow","level":"1.4.3","depth":2,"path":"attacks/overflow_underflow.md","ref":"attacks/overflow_underflow.md","articles":[]},"previous":{"title":"Transaction Ordering Dependence","level":"1.4.1.2","depth":3,"anchor":"#transaction-ordering-dependence","path":"attacks/race_condition.md","ref":"attacks/race_condition.md#transaction-ordering-dependence","articles":[]},"dir":"ltr"},"config":{"plugins":[],"root":"./docs","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Consensus System LLC","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"smart-contract-best-practices","language":"en","links":{"sidebar":{"Contact us":"https://github.com/ConsenSys/smart-contract-best-practices"}},"gitbook":">=3.0.0","description":""},"file":{"path":"attacks/gas_related_attacks.md","mtime":"2017-09-21T02:01:43.600Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-09-21T02:24:05.143Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

